<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Sistema de GestiÃ³n de Control de Unidades MÃ³viles de Pesaje"/>
  <meta name="theme-color" content="#007bff"/>
  <title>Sistema de GestiÃ³n de Control - UMP</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json"/>
  <link rel="apple-touch-icon" href="assets/icon-192.png"/>

  <!-- Styles -->
  <link rel="stylesheet" href="styles.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>

  <!-- Leaflet Maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <!-- Barra Superior -->
  <header class="top-bar">
    <div class="top-bar-left">
      <h1>ğŸš› Sistema de GestiÃ³n de Control - UMP</h1>
    </div>
    <div class="top-bar-right">
      <div class="user-menu">
        <button class="btn-icon" onclick="Users.showLoginModal()" id="btnUser">
          <span id="userDisplay">ğŸ‘¤ Invitado</span>
        </button>
      </div>
      <div class="notification-bell">
        <button class="btn-icon" onclick="Notifications.togglePanel()">
          ğŸ”” <span class="badge" id="notificationCount">0</span>
        </button>
      </div>
      <button class="btn-icon" onclick="App.toggleDarkMode()" title="Cambiar tema">
        <span id="themeIcon">ğŸŒ™</span>
      </button>
    </div>
  </header>

  <!-- Panel de Notificaciones -->
  <div id="notificationPanel" class="notification-panel hidden">
    <div class="notification-header">
      <h3>Notificaciones</h3>
      <button onclick="Notifications.clearAll()" class="btn-link">Limpiar todo</button>
    </div>
    <div id="notificationList" class="notification-list"></div>
  </div>

  <div class="container">
    <!-- NavegaciÃ³n de PestaÃ±as -->
    <nav class="tabs" role="tablist" aria-label="NavegaciÃ³n principal">
      <button class="tab-button active" role="tab" onclick="App.ui.showTab('formulario-tab', event)">ğŸ“ Ingreso de Datos</button>
      <button class="tab-button" role="tab" onclick="App.ui.showTab('gestion-tab', event)">ğŸ“‹ GestiÃ³n de Registros</button>
      <button class="tab-button" role="tab" onclick="App.ui.showTab('estadisticas-tab', event)">ğŸ“Š Dashboard</button>
      <button class="tab-button" role="tab" onclick="App.ui.showTab('analytics-tab', event)">ğŸ“ˆ Analytics</button>
      <button class="tab-button" role="tab" onclick="App.ui.showTab('calendario-tab', event)">ğŸ“… Calendario</button>
      <button class="tab-button" role="tab" onclick="App.ui.showTab('mapa-tab', event)">ğŸ—ºï¸ Mapa</button>
      <button class="tab-button" role="tab" onclick="App.ui.showTab('puntos-tab', event)">ğŸ“ Puntos</button>
    </nav>

    <!-- PestaÃ±a 1: Formulario -->
    <div id="formulario-tab" class="tab-content active" role="tabpanel">
      <h2>Nuevo Registro de Control</h2>
      <form id="controlForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="fecha">Fecha de Control <span class="required">*</span></label>
            <input type="date" id="fecha" required aria-required="true"/>
          </div>

          <div class="form-group">
            <label for="regionSelect">Filtrar por RegiÃ³n</label>
            <select id="regionSelect" aria-label="Filtrar puntos por regiÃ³n">
              <option value="">Todas las Regiones</option>
            </select>
          </div>

          <div class="form-group">
            <label for="puntoControl">Punto de Control <span class="required">*</span></label>
            <select id="puntoControl" required aria-required="true">
              <option value="">Seleccione un punto...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="region">RegiÃ³n</label>
            <input type="text" id="region" readonly/>
          </div>

          <div class="form-group">
            <label for="comuna">Comuna</label>
            <input type="text" id="comuna" readonly/>
          </div>

          <div class="form-group">
            <label for="provincia">Provincia</label>
            <input type="text" id="provincia" readonly/>
          </div>

          <div class="form-group">
            <label for="foso">Foso</label>
            <input type="text" id="foso" readonly/>
          </div>

          <div class="form-group">
            <label for="ruta">Ruta</label>
            <input type="text" id="ruta" readonly/>
          </div>

          <div class="form-group">
            <label for="kilometro">KilÃ³metro</label>
            <input type="text" id="kilometro" readonly/>
          </div>

          <div class="form-group">
            <label for="sentido">Sentido de Control</label>
            <input type="text" id="sentido" readonly/>
          </div>
        </div>

        <!-- SecciÃ³n Horario -->
        <div class="horario-section" style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid var(--primary-color);">
          <h3 style="margin-top: 0;">â° Horario de Control</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="horaInicio">Hora de Inicio <span class="required">*</span></label>
              <input type="time" id="horaInicio" required onchange="HorasControl.calcularTotal()"/>
              <small style="color: var(--text-secondary);">Hora de inicio del control</small>
            </div>
            <div class="form-group">
              <label for="horaFin">Hora de Fin <span class="required">*</span></label>
              <input type="time" id="horaFin" required onchange="HorasControl.calcularTotal()"/>
              <small style="color: var(--text-secondary);">Hora de finalizaciÃ³n del control</small>
            </div>
            <div class="form-group">
              <label>Total de Horas de Control</label>
              <div style="display:flex;gap:10px;align-items:center;">
                <input type="text" id="horasTotalDisplay" readonly style="background: var(--bg-tertiary); font-weight: bold; font-size: 18px; text-align: center;" placeholder="00:00:00"/>
                <button type="button" class="btn-secondary" onclick="HorasControl.ajustarManual()" style="padding:10px;">âš™ï¸ Ajustar</button>
              </div>
              <small style="color: var(--text-secondary);">Calculado automÃ¡ticamente</small>
            </div>
          </div>

          <!-- Ajuste Manual -->
          <div id="ajusteManualHoras" class="hidden" style="margin-top:15px;padding:15px;background:var(--bg-primary);border-radius:4px;border:1px dashed var(--border-color);">
            <h4 style="margin-top:0;font-size:14px;">âš™ï¸ Ajuste Manual de Horas</h4>
            <div class="horas-group">
              <div class="form-group">
                <input type="number" id="horasH" min="0" max="999" value="0"/>
                <label>Horas</label>
              </div>
              <div class="form-group">
                <input type="number" id="horasM" min="0" max="59" value="0"/>
                <label>Minutos</label>
              </div>
              <div class="form-group">
                <input type="number" id="horasS" min="0" max="59" value="0"/>
                <label>Segundos</label>
              </div>
              <button type="button" class="btn-primary" onclick="HorasControl.aplicarManual()">Aplicar</button>
            </div>
          </div>
        </div>

        <!-- Datos de VehÃ­culos -->
        <div class="form-grid">
          <div class="form-group">
            <label for="vehiculosControlados">VehÃ­culos Controlados <span class="required">*</span></label>
            <input type="number" id="vehiculosControlados" min="0" required onchange="HorasControl.calcularPromedios()"/>
          </div>
          <div class="form-group">
            <label for="vehiculosSobrepeso">VehÃ­culos con Sobrepeso <span class="required">*</span></label>
            <input type="number" id="vehiculosSobrepeso" min="0" required onchange="HorasControl.calcularPromedios()"/>
          </div>
          <div class="form-group">
            <label for="vehiculosInfraccionados">VehÃ­culos Infraccionados <span class="required">*</span></label>
            <input type="number" id="vehiculosInfraccionados" min="0" required onchange="HorasControl.calcularPromedios()"/>
          </div>
        </div>

        <!-- Indicadores en Vivo -->
        <div id="indicadoresVivo" class="stats-grid" style="margin:20px 0; display:none;">
          <div class="stat-card" style="border-left-color: var(--success-color);">
            <h3>Promedio Veh/Hora</h3>
            <p id="livePromedioVehHora">0</p>
          </div>
          <div class="stat-card" style="border-left-color: var(--warning-color);">
            <h3>% Sobrepeso</h3>
            <p id="livePorcentajeSobrepeso">0%</p>
          </div>
          <div class="stat-card" style="border-left-color: var(--danger-color);">
            <h3>% Infracciones</h3>
            <p id="livePorcentajeInfraccion">0%</p>
          </div>
        </div>

        <!-- Observaciones -->
        <div class="observaciones-section" style="margin: 20px 0;">
          <div class="form-group">
            <label for="observaciones">ğŸ“ Observaciones del Control
              <small style="font-weight: normal; color: var(--text-secondary);">(Opcional - MÃ¡x. 1000 caracteres)</small>
            </label>
            <textarea id="observaciones" rows="5" maxlength="1000"
              placeholder="Registre aquÃ­ informaciÃ³n relevante del control: incidentes, condiciones climÃ¡ticas, particularidades del dÃ­a, etc."
              style="width:100%;padding:12px;border:1px solid var(--border-color);border-radius:4px;font-family:inherit;font-size:14px;resize:vertical;background:var(--bg-primary);color:var(--text-primary);"
              oninput="HorasControl.actualizarContador(this)"></textarea>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:5px;">
              <small style="color: var(--text-secondary);">ğŸ’¡ Ejemplos: "Lluvia intensa", "Mayor flujo por feriado", "Carga irregular"</small>
              <small id="charCounter" style="color: var(--text-muted);">0 / 1000</small>
            </div>
          </div>

          <!-- Plantillas -->
          <div style="margin-top:10px;">
            <label style="font-size:13px;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:8px;">ğŸš€ Plantillas RÃ¡pidas:</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button type="button" class="btn-secondary" style="font-size:12px;padding:6px 12px;" onclick="HorasControl.agregarPlantilla('Control normal sin incidentes.')">âœ… Control Normal</button>
              <button type="button" class="btn-secondary" style="font-size:12px;padding:6px 12px;" onclick="HorasControl.agregarPlantilla('Condiciones climÃ¡ticas adversas (lluvia/viento).')">ğŸŒ§ï¸ Mal Clima</button>
              <button type="button" class="btn-secondary" style="font-size:12px;padding:6px 12px;" onclick="HorasControl.agregarPlantilla('Mayor flujo vehicular de lo habitual.')">ğŸš› Alto Flujo</button>
              <button type="button" class="btn-secondary" style="font-size:12px;padding:6px 12px;" onclick="HorasControl.agregarPlantilla('Se detectaron irregularidades en documentaciÃ³n.')">ğŸ“‹ Irregularidades</button>
              <button type="button" class="btn-secondary" style="font-size:12px;padding:6px 12px;" onclick="HorasControl.limpiarObservaciones()">ğŸ—‘ï¸ Limpiar</button>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <div class="form-actions-left">
            <button type="button" class="btn-success" onclick="App.ui.abrirModalNuevoPunto()">+ Agregar Nuevo Punto</button>
          </div>
          <div class="form-actions-right">
            <button type="button" class="btn-secondary" onclick="App.form.limpiar()">Limpiar</button>
            <button type="submit" class="btn-primary" id="guardarBtn">ğŸ’¾ Guardar Control</button>
          </div>
        </div>
      </form>
    </div>

    <!-- PestaÃ±a 2: GestiÃ³n -->
    <div id="gestion-tab" class="tab-content" role="tabpanel">
      <h2>GestiÃ³n de Registros</h2>

      <!-- Filtros Avanzados -->
      <div class="filters-panel">
        <button class="btn-secondary" onclick="Filters.togglePanel()">ğŸ” Filtros Avanzados</button>
        <div id="advancedFilters" class="advanced-filters hidden">
          <div class="form-grid">
            <div class="form-group">
              <label for="filterFechaDesde">Fecha Desde</label>
              <input type="date" id="filterFechaDesde"/>
            </div>
            <div class="form-group">
              <label for="filterFechaHasta">Fecha Hasta</label>
              <input type="date" id="filterFechaHasta"/>
            </div>
            <div class="form-group">
              <label for="filterRegion">RegiÃ³n</label>
              <select id="filterRegion">
                <option value="">Todas</option>
              </select>
            </div>
            <div class="form-group">
              <label for="filterPunto">Punto de Control</label>
              <select id="filterPunto">
                <option value="">Todos</option>
              </select>
            </div>
            <div class="form-group">
              <label for="filterMinVehiculos">Min. VehÃ­culos</label>
              <input type="number" id="filterMinVehiculos" min="0"/>
            </div>
            <div class="form-group">
              <label for="filterMaxInfraccion">% InfracciÃ³n Mayor a</label>
              <input type="number" id="filterMaxInfraccion" min="0" max="100"/>
            </div>
          </div>
          <div class="form-actions">
            <button class="btn-primary" onclick="Filters.apply()">Aplicar Filtros</button>
            <button class="btn-secondary" onclick="Filters.clear()">Limpiar</button>
          </div>
        </div>
      </div>

      <!-- BÃºsqueda -->
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="ğŸ” Buscar en registros (incluye observaciones)..." onkeyup="Filters.search(this.value)"/>
      </div>

      <!-- Acciones -->
      <div class="form-actions" style="margin-bottom: 20px;">
        <button type="button" class="btn-success" onclick="App.exportar.csv()">ğŸ“¥ Exportar CSV</button>
        <button type="button" class="btn-danger" onclick="PDFExport.generate()">ğŸ“„ Exportar PDF</button>
        <button type="button" class="btn-warning" onclick="Backup.export()">ğŸ’¾ Backup</button>
        <button type="button" class="btn-primary" onclick="Backup.import()">ğŸ“‚ Restaurar</button>
      </div>

      <!-- Tabla -->
      <div class="table-container">
        <table id="tablaControles">
          <thead>
            <tr>
              <th onclick="Filters.sortBy('fecha')">Fecha â¬</th>
              <th onclick="Filters.sortBy('region')">RegiÃ³n â¬</th>
              <th onclick="Filters.sortBy('puntoControl')">Punto â¬</th>
              <th>Horario</th>
              <th>Horas Total</th>
              <th onclick="Filters.sortBy('vehiculosControlados')">Controlados â¬</th>
              <th onclick="Filters.sortBy('vehiculosSobrepeso')">Sobrepeso â¬</th>
              <th onclick="Filters.sortBy('vehiculosInfraccionados')">Infracciones â¬</th>
              <th>Prom/H</th>
              <th onclick="Filters.sortBy('porcentajeSobrepeso')">% Sobre â¬</th>
              <th onclick="Filters.sortBy('porcentajeInfraccion')">% Infrac â¬</th>
              <th>Observaciones</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaCuerpo"></tbody>
        </table>
        <p id="mensajeVacio" style="text-align:center;color:#6c757d;margin-top:30px;">No hay registros guardados.</p>
      </div>

      <div id="pagination" class="pagination"></div>
    </div>

    <!-- PestaÃ±a 3: Dashboard -->
    <div id="estadisticas-tab" class="tab-content" role="tabpanel">
      <h2>Dashboard de EstadÃ­sticas</h2>
      <div class="stats-grid">
        <div class="stat-card"><h3>Total Controles</h3><p id="statTotalControles">0</p></div>
        <div class="stat-card"><h3>Total Horas</h3><p id="statTotalHoras">00:00:00</p></div>
        <div class="stat-card"><h3>Total VehÃ­culos</h3><p id="statTotalVehiculos">0</p></div>
        <div class="stat-card"><h3>Sobrepeso</h3><p id="statTotalSobrepeso">0</p></div>
        <div class="stat-card"><h3>Infracciones</h3><p id="statTotalInfracciones">0</p></div>
        <div class="stat-card"><h3>Prom. Veh/Hora</h3><p id="statPromedioGeneralVehiculosHora">0</p></div>
        <div class="stat-card"><h3>% Sobrepeso</h3><p id="statPorcentajeGeneralSobrepeso">0%</p></div>
        <div class="stat-card"><h3>% Infracciones</h3><p id="statPorcentajeGeneralInfracciones">0%</p></div>
      </div>
      <div class="charts-grid">
        <div class="chart-container"><h3>Controles por RegiÃ³n</h3><canvas id="chartRegiones"></canvas></div>
        <div class="chart-container"><h3>Tendencia Temporal</h3><canvas id="chartTemporal"></canvas></div>
        <div class="chart-container"><h3>DistribuciÃ³n de Infracciones</h3><canvas id="chartInfracciones"></canvas></div>
        <div class="chart-container"><h3>Top 10 Puntos de Control</h3><canvas id="chartTopPuntos"></canvas></div>
      </div>
    </div>

    <!-- PestaÃ±a 4: Analytics -->
    <div id="analytics-tab" class="tab-content" role="tabpanel">
      <h2>AnÃ¡lisis Avanzado</h2>
      <div class="analytics-section">
        <h3>ğŸ“Š Comparativas Temporales</h3>
        <div class="comparison-cards">
          <div class="comparison-card"><h4>Este Mes vs Mes Anterior</h4><div id="comparisonMes"></div></div>
          <div class="comparison-card"><h4>Este AÃ±o vs AÃ±o Anterior</h4><div id="comparisonAnio"></div></div>
        </div>
      </div>
      <div class="analytics-section">
        <h3>ğŸ† Rankings</h3>
        <div class="rankings-grid">
          <div class="ranking-card"><h4>Top 5 Regiones con MÃ¡s Controles</h4><div id="rankingRegiones"></div></div>
          <div class="ranking-card"><h4>Puntos con Mayor % de Infracciones</h4><div id="rankingInfracciones"></div></div>
        </div>
      </div>
      <div class="analytics-section">
        <h3>ğŸ”® Predicciones y Tendencias</h3>
        <div id="predictions"></div>
      </div>
    </div>

    <!-- PestaÃ±a 5: Calendario -->
    <div id="calendario-tab" class="tab-content" role="tabpanel">
      <h2>Calendario de Controles</h2>
      <div id="calendar"></div>
    </div>

    <!-- PestaÃ±a 6: Mapa -->
    <div id="mapa-tab" class="tab-content" role="tabpanel">
      <h2>Mapa de Puntos de Control</h2>
      <div class="map-controls">
        <button class="btn-primary" onclick="MapModule.showAll()">Mostrar Todos</button>
        <button class="btn-secondary" onclick="MapModule.filterByInfractions()">Filtrar por Infracciones</button>
      </div>
      <div id="map" style="height: 600px; border-radius: 8px;"></div>
    </div>

    <!-- PestaÃ±a 7: Puntos -->
    <div id="puntos-tab" class="tab-content" role="tabpanel">
      <h2>Administrar Puntos de Control</h2>
      <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;">
        <button type="button" class="btn-success" onclick="App.ui.abrirModalNuevoPunto()">+ Agregar Nuevo Punto</button>
        <button type="button" class="btn-primary" onclick="CoordenadasHelper.importarCSV()">ğŸ“¥ Importar Coordenadas CSV</button>
        <button type="button" class="btn-secondary" onclick="CoordenadasHelper.descargarPlantillaCSV()">ğŸ“„ Plantilla CSV</button>
      </div>
      <div class="table-container">
        <table id="tablaPuntos">
          <thead>
            <tr>
              <th>Punto</th>
              <th>RegiÃ³n</th>
              <th>Comuna</th>
              <th>Tipo</th>
              <th>Ruta/Km</th>
              <th style="text-align:center;">GPS</th>
              <th>Coordenadas</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaPuntosCuerpo"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Punto -->
  <div id="modalNuevoPunto" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-content">
      <span class="close" onclick="App.ui.cerrarModalNuevoPunto()">&times;</span>
      <h2 id="modalTitulo">Agregar Punto de Control</h2>
      <form id="formNuevoPunto">
        <input type="hidden" id="editandoPuntoNombre"/>

        <h3 style="margin-top:0;border-bottom:2px solid var(--primary-color);padding-bottom:10px;">ğŸ“ InformaciÃ³n BÃ¡sica</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="nuevoPuntoNombre">Nombre del Punto <span class="required">*</span></label>
            <input type="text" id="nuevoPuntoNombre" required/>
          </div>
          <div class="form-group">
            <label for="nuevoPuntoRegion">RegiÃ³n <span class="required">*</span></label>
            <input type="text" id="nuevoPuntoRegion" required/>
          </div>
          <div class="form-group">
            <label for="nuevoPuntoComuna">Comuna <span class="required">*</span></label>
            <input type="text" id="nuevoPuntoComuna" required/>
          </div>
          <div class="form-group">
            <label for="nuevoPuntoProvincia">Provincia <span class="required">*</span></label>
            <input type="text" id="nuevoPuntoProvincia" required/>
          </div>
          <div class="form-group">
            <label for="nuevoPuntoTipo">Tipo de Control <span class="required">*</span></label>
            <select id="nuevoPuntoTipo" required>
              <option value="Pista de Pesaje">Pista de Pesaje</option>
              <option value="Calzada">Calzada</option>
            </select>
          </div>
          <div class="form-group">
            <label for="nuevoPuntoFoso">Foso <span class="required">*</span></label>
            <select id="nuevoPuntoFoso" required>
              <option value="Si">SÃ­</option>
              <option value="No">No</option>
            </select>
          </div>
          <div class="form-group">
            <label for="nuevoPuntoRuta">Ruta <span class="required">*</span></label>
            <input type="text" id="nuevoPuntoRuta" required/>
          </div>
          <div class="form-group">
            <label for="nuevoPuntoKm">KilÃ³metro <span class="required">*</span></label>
            <input type="text" id="nuevoPuntoKm" required/>
          </div>
          <div class="form-group">
            <label for="nuevoPuntoSentido">Sentido de Control <span class="required">*</span></label>
            <input type="text" id="nuevoPuntoSentido" required/>
          </div>
        </div>

        <h3 style="margin-top:30px;border-bottom:2px solid var(--success-color);padding-bottom:10px;">ğŸŒ Coordenadas GPS</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="nuevoPuntoLat">Latitud <small style="color:var(--text-secondary);">(Ej: -18.537829)</small></label>
            <input type="number" id="nuevoPuntoLat" step="0.000001" min="-90" max="90" placeholder="-33.4489" onchange="CoordenadasHelper.validar('nuevoPuntoLat')"/>
            <small id="latError" style="color: var(--danger-color); display: none;">âš ï¸ Latitud invÃ¡lida</small>
          </div>
          <div class="form-group">
            <label for="nuevoPuntoLng">Longitud <small style="color:var(--text-secondary);">(Ej: -70.771886)</small></label>
            <input type="number" id="nuevoPuntoLng" step="0.000001" min="-180" max="180" placeholder="-70.6693" onchange="CoordenadasHelper.validar('nuevoPuntoLng')"/>
            <small id="lngError" style="color: var(--danger-color); display: none;">âš ï¸ Longitud invÃ¡lida</small>
          </div>
        </div>

        <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid var(--info-color);">
          <h4 style="margin:0 0 10px 0; font-size:14px;">ğŸ’¡ Â¿CÃ³mo obtener coordenadas?</h4>
          <ol style="margin:0; padding-left:20px; font-size:13px;">
            <li>Abre <a href="https://www.google.com/maps" target="_blank" style="color: var(--primary-color);">Google Maps</a></li>
            <li>Busca el punto de control</li>
            <li>Click derecho â†’ "Â¿QuÃ© hay aquÃ­?"</li>
            <li>Copia las coordenadas (aparecen abajo)</li>
          </ol>
          <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;">
            <button type="button" class="btn-secondary" style="font-size:12px;padding:6px 12px;" onclick="CoordenadasHelper.obtenerUbicacion()">ğŸ“ Usar Mi UbicaciÃ³n</button>
            <button type="button" class="btn-secondary" style="font-size:12px;padding:6px 12px;" onclick="CoordenadasHelper.abrirMaps()">ğŸ—ºï¸ Abrir Google Maps</button>
          </div>
        </div>

        <div id="previewMap" style="height: 200px; border-radius: 8px; margin: 15px 0; border: 2px solid var(--border-color); display: none;"></div>
        <button type="button" class="btn-secondary" onclick="CoordenadasHelper.previsualizarMapa()" style="width: 100%; margin-bottom: 15px;">ğŸ‘ï¸ Previsualizar en Mapa</button>

        <div class="form-actions" style="justify-content:flex-end;">
          <button type="button" class="btn-secondary" onclick="App.ui.cerrarModalNuevoPunto()">Cancelar</button>
          <button type="submit" class="btn-primary" id="btnGuardarPunto">ğŸ’¾ Guardar Punto</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Login -->
  <div id="modalLogin" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-content modal-small">
      <span class="close" onclick="Users.closeLoginModal()">&times;</span>
      <h2>Iniciar SesiÃ³n</h2>
      <form id="loginForm">
        <div class="form-group">
          <label for="username">Usuario</label>
          <input type="text" id="username" required/>
        </div>
        <div class="form-group">
          <label for="password">ContraseÃ±a</label>
          <input type="password" id="password" required/>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn-primary">Entrar</button>
        </div>
      </form>
      <p style="text-align: center; margin-top: 10px; font-size: 12px;">Demo: admin/admin | editor/editor | viewer/viewer</p>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Scripts -->
  <script src="script.js"></script>
  <script src="Modules/horas-control.js"></script>
  <script src="Modules/coordenadas-helper.js"></script>
  <script src="Modules/filters.js"></script>
  <script src="Modules/charts.js"></script>
  <script src="Modules/pdf-export.js"></script>
  <script src="Modules/backup.js"></script>
  <script src="Modules/calendar.js"></script>
  <script src="Modules/notifications.js"></script>
  <script src="Modules/maps.js"></script>
  <script src="Modules/users.js"></script>
  <script src="Modules/analytics.js"></script>

  <!-- PWA -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('âœ… Service Worker registrado'))
        .catch(err => console.log('âŒ Error SW:', err));
    }
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (typeof Notifications !== 'undefined') {
        Notifications.add('ğŸ“± Â¡Puedes instalar esta app en tu dispositivo!', 'info');
      }
    });
  </script>
</body>
</html>