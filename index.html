<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Sistema de Gesti√≥n de Control de Unidades M√≥viles de Pesaje"/>
  <meta name="theme-color" content="#007bff"/>
  
  <!-- Seguridad -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="referrer" content="strict-origin-when-cross-origin"/>
  
  <title>Sistema de Gesti√≥n de Control - UMP</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json"/>
  <link rel="apple-touch-icon" href="assets/icon-192.png"/>

  <!-- Styles -->
  <link rel="stylesheet" href="styles.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js" defer></script>

  <!-- Leaflet Maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
</head>
<body>
  <!-- ============================================
       BARRA SUPERIOR
       ============================================ -->
  <header class="top-bar">
    <div class="top-bar-left">
      <h1>üöõ Sistema de Gesti√≥n de Control - UMP</h1>
    </div>
    <div class="top-bar-right">
      <!-- Usuario -->
      <div class="user-menu">
        <button class="btn-icon" data-action="show-login" id="btnUser" aria-label="Men√∫ de usuario">
          <span id="userDisplay">üë§ Invitado</span>
        </button>
      </div>
      
      <!-- Notificaciones -->
      <div class="notification-bell">
        <button class="btn-icon" data-action="toggle-notifications" aria-label="Notificaciones">
          üîî <span class="badge" id="notificationCount">0</span>
        </button>
      </div>
      
      <!-- Mapa Externo (NUEVO) -->
      <a href="MAPA.HTML" class="btn-icon" title="Abrir Mapa Completo" aria-label="Abrir mapa en nueva ventana" target="_blank" rel="noopener noreferrer">
        üó∫Ô∏è <span class="sr-only">Mapa Completo</span>
      </a>
      
      <!-- Tema -->
      <button class="btn-icon" data-action="toggle-theme" title="Cambiar tema" aria-label="Cambiar tema claro/oscuro">
        <span id="themeIcon">üåô</span>
      </button>
    </div>
  </header>

  <!-- ============================================
       PANEL DE NOTIFICACIONES
       ============================================ -->
  <aside id="notificationPanel" class="notification-panel hidden" role="complementary" aria-label="Panel de notificaciones">
    <div class="notification-header">
      <h3>Notificaciones</h3>
      <button data-action="clear-notifications" class="btn-link" aria-label="Limpiar todas las notificaciones">Limpiar todo</button>
    </div>
    <div id="notificationList" class="notification-list" role="list"></div>
  </aside>

  <div class="container">
    <!-- ============================================
         NAVEGACI√ìN DE PESTA√ëAS
         ============================================ -->
    <nav class="tabs" role="tablist" aria-label="Navegaci√≥n principal">
      <button class="tab-button active" 
              role="tab" 
              data-action="show-tab" 
              data-tab="formulario-tab" 
              aria-selected="true" 
              aria-controls="formulario-tab">
        üìù Ingreso de Datos
      </button>
      <button class="tab-button" 
              role="tab" 
              data-action="show-tab" 
              data-tab="gestion-tab" 
              aria-selected="false" 
              aria-controls="gestion-tab">
        üìã Gesti√≥n de Registros
      </button>
      <button class="tab-button" 
              role="tab" 
              data-action="show-tab" 
              data-tab="estadisticas-tab" 
              aria-selected="false" 
              aria-controls="estadisticas-tab">
        üìä Dashboard
      </button>
      <button class="tab-button" 
              role="tab" 
              data-action="show-tab" 
              data-tab="analytics-tab" 
              aria-selected="false" 
              aria-controls="analytics-tab">
        üìà Analytics
      </button>
      <button class="tab-button" 
              role="tab" 
              data-action="show-tab" 
              data-tab="calendario-tab" 
              aria-selected="false" 
              aria-controls="calendario-tab">
        üìÖ Calendario
      </button>
      <button class="tab-button" 
              role="tab" 
              data-action="show-tab" 
              data-tab="mapa-tab" 
              aria-selected="false" 
              aria-controls="mapa-tab">
        üó∫Ô∏è Mapa Integrado
      </button>
      <button class="tab-button" 
              role="tab" 
              data-action="show-tab" 
              data-tab="puntos-tab" 
              aria-selected="false" 
              aria-controls="puntos-tab">
        üìç Puntos
      </button>
    </nav>

    <!-- ============================================
         PESTA√ëA 1: FORMULARIO DE INGRESO
         ============================================ -->
    <section id="formulario-tab" class="tab-content active" role="tabpanel" aria-labelledby="tab-formulario">
      <h2>Nuevo Registro de Control</h2>
      <form id="controlForm" novalidate>
        <!-- Datos B√°sicos -->
        <div class="form-grid">
          <div class="form-group">
            <label for="fecha">Fecha de Control <span class="required">*</span></label>
            <input type="date" 
                   id="fecha" 
                   name="fecha" 
                   required 
                   aria-required="true"
                   aria-describedby="fecha-help"/>
            <small id="fecha-help" class="help-text">No puede ser fecha futura</small>
          </div>

          <div class="form-group">
            <label for="regionSelect">Filtrar por Regi√≥n</label>
            <select id="regionSelect" 
                    name="regionFilter" 
                    aria-label="Filtrar puntos por regi√≥n"
                    data-action="filter-region">
              <option value="">Todas las Regiones</option>
            </select>
          </div>

          <div class="form-group">
            <label for="puntoControl">Punto de Control <span class="required">*</span></label>
            <select id="puntoControl" 
                    name="puntoControl" 
                    required 
                    aria-required="true"
                    data-action="select-punto">
              <option value="">Seleccione un punto...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="region">Regi√≥n</label>
            <input type="text" id="region" name="region" readonly aria-readonly="true"/>
          </div>

          <div class="form-group">
            <label for="comuna">Comuna</label>
            <input type="text" id="comuna" name="comuna" readonly aria-readonly="true"/>
          </div>

          <div class="form-group">
            <label for="provincia">Provincia</label>
            <input type="text" id="provincia" name="provincia" readonly aria-readonly="true"/>
          </div>

          <div class="form-group">
            <label for="foso">Foso</label>
            <input type="text" id="foso" name="foso" readonly aria-readonly="true"/>
          </div>

          <div class="form-group">
            <label for="ruta">Ruta</label>
            <input type="text" id="ruta" name="ruta" readonly aria-readonly="true"/>
          </div>

          <div class="form-group">
            <label for="kilometro">Kil√≥metro</label>
            <input type="text" id="kilometro" name="kilometro" readonly aria-readonly="true"/>
          </div>

          <div class="form-group">
            <label for="sentido">Sentido de Control</label>
            <input type="text" id="sentido" name="sentido" readonly aria-readonly="true"/>
          </div>
        </div>

        <!-- ============================================
             SECCI√ìN HORARIO
             ============================================ -->
        <fieldset class="horario-section" style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid var(--primary-color);">
          <legend style="font-size: 18px; font-weight: 600; margin-bottom: 15px;">‚è∞ Horario de Control</legend>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="horaInicio">Hora de Inicio <span class="required">*</span></label>
              <input type="time" 
                     id="horaInicio" 
                     name="horaInicio" 
                     required 
                     aria-required="true"
                     data-action="calcular-horas"/>
              <small class="help-text">Hora de inicio del control</small>
            </div>

            <div class="form-group">
              <label for="horaFin">Hora de Fin <span class="required">*</span></label>
              <input type="time" 
                     id="horaFin" 
                     name="horaFin" 
                     required 
                     aria-required="true"
                     data-action="calcular-horas"/>
              <small class="help-text">Hora de finalizaci√≥n del control</small>
            </div>

            <div class="form-group">
              <label for="horasTotalDisplay">Total de Horas de Control</label>
              <div style="display:flex;gap:10px;align-items:center;">
                <input type="text" 
                       id="horasTotalDisplay" 
                       readonly 
                       aria-readonly="true"
                       style="background: var(--bg-tertiary); font-weight: bold; font-size: 18px; text-align: center;" 
                       placeholder="00:00:00"
                       aria-describedby="horas-total-help"/>
                <button type="button" 
                        class="btn-secondary" 
                        data-action="ajustar-horas-manual" 
                        style="padding:10px;"
                        aria-label="Ajustar horas manualmente">
                  ‚öôÔ∏è Ajustar
                </button>
              </div>
              <small id="horas-total-help" class="help-text">Calculado autom√°ticamente</small>
            </div>
          </div>

          <!-- Ajuste Manual (oculto por defecto) -->
          <div id="ajusteManualHoras" 
               class="hidden" 
               style="margin-top:15px;padding:15px;background:var(--bg-primary);border-radius:4px;border:1px dashed var(--border-color);"
               aria-hidden="true">
            <h4 style="margin-top:0;font-size:14px;">‚öôÔ∏è Ajuste Manual de Horas</h4>
            <div class="horas-group" style="display:flex;gap:10px;align-items:end;flex-wrap:wrap;">
              <div class="form-group" style="flex:1;min-width:80px;">
                <label for="horasH">Horas</label>
                <input type="number" 
                       id="horasH" 
                       name="horasH" 
                       min="0" 
                       max="999" 
                       value="0"
                       aria-label="Horas"/>
              </div>
              <div class="form-group" style="flex:1;min-width:80px;">
                <label for="horasM">Minutos</label>
                <input type="number" 
                       id="horasM" 
                       name="horasM" 
                       min="0" 
                       max="59" 
                       value="0"
                       aria-label="Minutos"/>
              </div>
              <div class="form-group" style="flex:1;min-width:80px;">
                <label for="horasS">Segundos</label>
                <input type="number" 
                       id="horasS" 
                       name="horasS" 
                       min="0" 
                       max="59" 
                       value="0"
                       aria-label="Segundos"/>
              </div>
              <button type="button" 
                      class="btn-primary" 
                      data-action="aplicar-horas-manual"
                      style="flex:0;">
                Aplicar
              </button>
            </div>
          </div>
        </fieldset>

        <!-- ============================================
             DATOS DE VEH√çCULOS
             ============================================ -->
        <div class="form-grid">
          <div class="form-group">
            <label for="vehiculosControlados">Veh√≠culos Controlados <span class="required">*</span></label>
            <input type="number" 
                   id="vehiculosControlados" 
                   name="vehiculosControlados" 
                   min="0" 
                   max="99999"
                   required 
                   aria-required="true"
                   data-action="calcular-promedios"
                   aria-describedby="vehiculos-help"/>
            <small id="vehiculos-help" class="help-text">Total de veh√≠culos pesados</small>
          </div>

          <div class="form-group">
            <label for="vehiculosSobrepeso">Veh√≠culos con Sobrepeso <span class="required">*</span></label>
            <input type="number" 
                   id="vehiculosSobrepeso" 
                   name="vehiculosSobrepeso" 
                   min="0" 
                   max="99999"
                   required 
                   aria-required="true"
                   data-action="calcular-promedios"
                   aria-describedby="sobrepeso-help"/>
            <small id="sobrepeso-help" class="help-text">No puede superar controlados</small>
          </div>

          <div class="form-group">
            <label for="vehiculosInfraccionados">Veh√≠culos Infraccionados <span class="required">*</span></label>
            <input type="number" 
                   id="vehiculosInfraccionados" 
                   name="vehiculosInfraccionados" 
                   min="0" 
                   max="99999"
                   required 
                   aria-required="true"
                   data-action="calcular-promedios"
                   aria-describedby="infraccion-help"/>
            <small id="infraccion-help" class="help-text">No puede superar controlados</small>
          </div>
        </div>

        <!-- ============================================
             INDICADORES EN VIVO
             ============================================ -->
        <div id="indicadoresVivo" class="stats-grid" style="margin:20px 0; display:none;" role="region" aria-live="polite">
          <div class="stat-card" style="border-left-color: var(--success-color);">
            <h3>Promedio Veh/Hora</h3>
            <p id="livePromedioVehHora" aria-label="Promedio de veh√≠culos por hora">0</p>
          </div>
          <div class="stat-card" style="border-left-color: var(--warning-color);">
            <h3>% Sobrepeso</h3>
            <p id="livePorcentajeSobrepeso" aria-label="Porcentaje de sobrepeso">0%</p>
          </div>
          <div class="stat-card" style="border-left-color: var(--danger-color);">
            <h3>% Infracciones</h3>
            <p id="livePorcentajeInfraccion" aria-label="Porcentaje de infracciones">0%</p>
          </div>
        </div>

        <!-- ============================================
             OBSERVACIONES
             ============================================ -->
        <fieldset class="observaciones-section" style="margin: 20px 0;">
          <legend class="sr-only">Observaciones del control</legend>
          
          <div class="form-group">
            <label for="observaciones">
              üìù Observaciones del Control
              <small style="font-weight: normal; color: var(--text-secondary);">(Opcional - M√°x. 1000 caracteres)</small>
            </label>
            <textarea id="observaciones" 
                      name="observaciones" 
                      rows="5" 
                      maxlength="1000"
                      placeholder="Registre aqu√≠ informaci√≥n relevante del control: incidentes, condiciones clim√°ticas, particularidades del d√≠a, etc."
                      style="width:100%;padding:12px;border:1px solid var(--border-color);border-radius:4px;font-family:inherit;font-size:14px;resize:vertical;background:var(--bg-primary);color:var(--text-primary);"
                      data-action="actualizar-contador"
                      aria-describedby="obs-help obs-counter"></textarea>
            
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:5px;">
              <small id="obs-help" class="help-text">üí° Ejemplos: "Lluvia intensa", "Mayor flujo por feriado", "Carga irregular"</small>
              <small id="charCounter" aria-live="polite" style="color: var(--text-muted);">0 / 1000</small>
            </div>
          </div>

          <!-- Plantillas R√°pidas -->
          <div style="margin-top:10px;">
            <label style="font-size:13px;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:8px;">
              üöÄ Plantillas R√°pidas:
            </label>
            <div style="display:flex;gap:8px;flex-wrap:wrap;" role="group" aria-label="Plantillas de observaciones">
              <button type="button" 
                      class="btn-secondary" 
                      style="font-size:12px;padding:6px 12px;" 
                      data-action="plantilla-obs" 
                      data-texto="Control normal sin incidentes.">
                ‚úÖ Control Normal
              </button>
              <button type="button" 
                      class="btn-secondary" 
                      style="font-size:12px;padding:6px 12px;" 
                      data-action="plantilla-obs" 
                      data-texto="Condiciones clim√°ticas adversas (lluvia/viento).">
                üåßÔ∏è Mal Clima
              </button>
              <button type="button" 
                      class="btn-secondary" 
                      style="font-size:12px;padding:6px 12px;" 
                      data-action="plantilla-obs" 
                      data-texto="Mayor flujo vehicular de lo habitual.">
                üöõ Alto Flujo
              </button>
              <button type="button" 
                      class="btn-secondary" 
                      style="font-size:12px;padding:6px 12px;" 
                      data-action="plantilla-obs" 
                      data-texto="Se detectaron irregularidades en documentaci√≥n.">
                üìã Irregularidades
              </button>
              <button type="button" 
                      class="btn-secondary" 
                      style="font-size:12px;padding:6px 12px;" 
                      data-action="limpiar-obs">
                üóëÔ∏è Limpiar
              </button>
            </div>
          </div>
        </fieldset>

        <!-- ============================================
             ACCIONES DEL FORMULARIO
             ============================================ -->
        <div class="form-actions">
          <div class="form-actions-left">
            <button type="button" 
                    class="btn-success" 
                    data-action="nuevo-punto"
                    aria-label="Agregar nuevo punto de control">
              + Agregar Nuevo Punto
            </button>
          </div>
          <div class="form-actions-right">
            <button type="button" 
                    class="btn-secondary" 
                    data-action="limpiar-form"
                    aria-label="Limpiar formulario">
              Limpiar
            </button>
            <button type="submit" 
                    class="btn-primary" 
                    id="guardarBtn"
                    data-loading="false">
              <span class="btn-text">üíæ Guardar Control</span>
              <span class="btn-spinner hidden">‚è≥ Guardando...</span>
            </button>
          </div>
        </div>
      </form>
    </section>

    <!-- ============================================
         PESTA√ëA 2: GESTI√ìN DE REGISTROS
         ============================================ -->
    <section id="gestion-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-gestion">
      <h2>Gesti√≥n de Registros</h2>

      <!-- Filtros Avanzados -->
      <div class="filters-panel">
        <button class="btn-secondary" data-action="toggle-filters" aria-expanded="false" aria-controls="advancedFilters">
          üîç Filtros Avanzados
        </button>
        
        <div id="advancedFilters" class="advanced-filters hidden" aria-hidden="true">
          <div class="form-grid">
            <div class="form-group">
              <label for="filterFechaDesde">Fecha Desde</label>
              <input type="date" id="filterFechaDesde" name="filterFechaDesde"/>
            </div>
            <div class="form-group">
              <label for="filterFechaHasta">Fecha Hasta</label>
              <input type="date" id="filterFechaHasta" name="filterFechaHasta"/>
            </div>
            <div class="form-group">
              <label for="filterRegion">Regi√≥n</label>
              <select id="filterRegion" name="filterRegion">
                <option value="">Todas</option>
              </select>
            </div>
            <div class="form-group">
              <label for="filterPunto">Punto de Control</label>
              <select id="filterPunto" name="filterPunto">
                <option value="">Todos</option>
              </select>
            </div>
            <div class="form-group">
              <label for="filterMinVehiculos">Min. Veh√≠culos</label>
              <input type="number" id="filterMinVehiculos" name="filterMinVehiculos" min="0"/>
            </div>
            <div class="form-group">
              <label for="filterMaxInfraccion">% Infracci√≥n Mayor a</label>
              <input type="number" id="filterMaxInfraccion" name="filterMaxInfraccion" min="0" max="100"/>
            </div>
          </div>
          <div class="form-actions">
            <button class="btn-primary" data-action="aplicar-filtros">Aplicar Filtros</button>
            <button class="btn-secondary" data-action="limpiar-filtros">Limpiar</button>
          </div>
        </div>
      </div>

      <!-- B√∫squeda -->
      <div class="search-bar">
        <label for="searchInput" class="sr-only">Buscar en registros</label>
        <input type="search" 
               id="searchInput" 
               placeholder="üîç Buscar en registros (incluye observaciones)..." 
               data-action="buscar-registros"
               aria-label="Buscar en registros"/>
      </div>

      <!-- Acciones de Exportaci√≥n -->
      <div class="form-actions" style="margin-bottom: 20px;" role="toolbar" aria-label="Acciones de exportaci√≥n">
        <button type="button" class="btn-success" data-action="exportar-csv" aria-label="Exportar datos a CSV">
          üì• Exportar CSV
        </button>
        <button type="button" class="btn-danger" data-action="exportar-pdf" aria-label="Exportar datos a PDF">
          üìÑ Exportar PDF
        </button>
        <button type="button" class="btn-warning" data-action="backup-exportar" aria-label="Crear copia de seguridad">
          üíæ Backup
        </button>
        <button type="button" class="btn-primary" data-action="backup-importar" aria-label="Restaurar desde backup">
          üìÇ Restaurar
        </button>
      </div>

      <!-- Tabla de Registros -->
      <div class="table-container" role="region" aria-label="Tabla de registros de control">
        <table id="tablaControles" role="table">
          <thead>
            <tr role="row">
              <th role="columnheader" data-action="sort" data-column="fecha" tabindex="0" aria-sort="none">
                Fecha <span aria-hidden="true">‚¨ç</span>
              </th>
              <th role="columnheader" data-action="sort" data-column="region" tabindex="0" aria-sort="none">
                Regi√≥n <span aria-hidden="true">‚¨ç</span>
              </th>
              <th role="columnheader" data-action="sort" data-column="puntoControl" tabindex="0" aria-sort="none">
                Punto <span aria-hidden="true">‚¨ç</span>
              </th>
              <th role="columnheader">Horario</th>
              <th role="columnheader">Horas Total</th>
              <th role="columnheader" data-action="sort" data-column="vehiculosControlados" tabindex="0" aria-sort="none">
                Controlados <span aria-hidden="true">‚¨ç</span>
              </th>
              <th role="columnheader" data-action="sort" data-column="vehiculosSobrepeso" tabindex="0" aria-sort="none">
                Sobrepeso <span aria-hidden="true">‚¨ç</span>
              </th>
              <th role="columnheader" data-action="sort" data-column="vehiculosInfraccionados" tabindex="0" aria-sort="none">
                Infracciones <span aria-hidden="true">‚¨ç</span>
              </th>
              <th role="columnheader">Prom/H</th>
              <th role="columnheader" data-action="sort" data-column="porcentajeSobrepeso" tabindex="0" aria-sort="none">
                % Sobre <span aria-hidden="true">‚¨ç</span>
              </th>
              <th role="columnheader" data-action="sort" data-column="porcentajeInfraccion" tabindex="0" aria-sort="none">
                % Infrac <span aria-hidden="true">‚¨ç</span>
              </th>
              <th role="columnheader">Observaciones</th>
              <th role="columnheader">Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaCuerpo" role="rowgroup"></tbody>
        </table>
        <p id="mensajeVacio" style="text-align:center;color:#6c757d;margin-top:30px;" role="status">
          No hay registros guardados.
        </p>
      </div>

      <!-- Paginaci√≥n -->
      <nav id="pagination" class="pagination" role="navigation" aria-label="Paginaci√≥n de registros"></nav>
    </section>

    <!-- ============================================
         PESTA√ëA 3: DASHBOARD DE ESTAD√çSTICAS
         ============================================ -->
    <section id="estadisticas-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-estadisticas">
      <h2>Dashboard de Estad√≠sticas</h2>
      
      <div class="stats-grid" role="region" aria-label="Estad√≠sticas generales">
        <div class="stat-card">
          <h3>Total Controles</h3>
          <p id="statTotalControles" aria-label="Total de controles realizados">0</p>
        </div>
        <div class="stat-card">
          <h3>Total Horas</h3>
          <p id="statTotalHoras" aria-label="Total de horas de control">00:00:00</p>
        </div>
        <div class="stat-card">
          <h3>Total Veh√≠culos</h3>
          <p id="statTotalVehiculos" aria-label="Total de veh√≠culos controlados">0</p>
        </div>
        <div class="stat-card">
          <h3>Sobrepeso</h3>
          <p id="statTotalSobrepeso" aria-label="Total de veh√≠culos con sobrepeso">0</p>
        </div>
        <div class="stat-card">
          <h3>Infracciones</h3>
          <p id="statTotalInfracciones" aria-label="Total de infracciones">0</p>
        </div>
        <div class="stat-card">
          <h3>Prom. Veh/Hora</h3>
          <p id="statPromedioGeneralVehiculosHora" aria-label="Promedio general de veh√≠culos por hora">0</p>
        </div>
        <div class="stat-card">
          <h3>% Sobrepeso</h3>
          <p id="statPorcentajeGeneralSobrepeso" aria-label="Porcentaje general de sobrepeso">0%</p>
        </div>
        <div class="stat-card">
          <h3>% Infracciones</h3>
          <p id="statPorcentajeGeneralInfracciones" aria-label="Porcentaje general de infracciones">0%</p>
        </div>
      </div>

      <div class="charts-grid" role="region" aria-label="Gr√°ficos estad√≠sticos">
        <div class="chart-container">
          <h3>Controles por Regi√≥n</h3>
          <canvas id="chartRegiones" role="img" aria-label="Gr√°fico de controles por regi√≥n"></canvas>
        </div>
        <div class="chart-container">
          <h3>Tendencia Temporal</h3>
          <canvas id="chartTemporal" role="img" aria-label="Gr√°fico de tendencia temporal"></canvas>
        </div>
        <div class="chart-container">
          <h3>Distribuci√≥n de Infracciones</h3>
          <canvas id="chartInfracciones" role="img" aria-label="Gr√°fico de distribuci√≥n de infracciones"></canvas>
        </div>
        <div class="chart-container">
          <h3>Top 10 Puntos de Control</h3>
          <canvas id="chartTopPuntos" role="img" aria-label="Gr√°fico de top 10 puntos de control"></canvas>
        </div>
      </div>
    </section>

    <!-- ============================================
         PESTA√ëA 4: ANALYTICS AVANZADO
         ============================================ -->
    <section id="analytics-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-analytics">
      <h2>An√°lisis Avanzado</h2>
      
      <div class="analytics-section">
        <h3>üìä Comparativas Temporales</h3>
        <div class="comparison-cards">
          <div class="comparison-card">
            <h4>Este Mes vs Mes Anterior</h4>
            <div id="comparisonMes" aria-live="polite"></div>
          </div>
          <div class="comparison-card">
            <h4>Este A√±o vs A√±o Anterior</h4>
            <div id="comparisonAnio" aria-live="polite"></div>
          </div>
        </div>
      </div>

      <div class="analytics-section">
        <h3>üèÜ Rankings</h3>
        <div class="rankings-grid">
          <div class="ranking-card">
            <h4>Top 5 Regiones con M√°s Controles</h4>
            <div id="rankingRegiones" role="list"></div>
          </div>
          <div class="ranking-card">
            <h4>Puntos con Mayor % de Infracciones</h4>
            <div id="rankingInfracciones" role="list"></div>
          </div>
        </div>
      </div>

      <div class="analytics-section">
        <h3>üîÆ Predicciones y Tendencias</h3>
        <div id="predictions" aria-live="polite"></div>
      </div>
    </section>

    <!-- ============================================
         PESTA√ëA 5: CALENDARIO
         ============================================ -->
    <section id="calendario-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-calendario">
      <h2>Calendario de Controles</h2>
      <div id="calendar" role="application" aria-label="Calendario de controles"></div>
    </section>

    <!-- ============================================
         PESTA√ëA 6: MAPA INTEGRADO
         ============================================ -->
    <section id="mapa-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-mapa">
      <h2>Mapa de Puntos de Control</h2>
      
      <div class="map-controls" role="toolbar" aria-label="Controles del mapa">
        <button class="btn-primary" data-action="mapa-mostrar-todos">Mostrar Todos</button>
        <button class="btn-secondary" data-action="mapa-filtrar-infracciones">Filtrar por Infracciones</button>
        <a href="MAPA.HTML" class="btn-success" target="_blank" rel="noopener noreferrer">
          üó∫Ô∏è Abrir Mapa Completo
        </a>
      </div>
      
      <div id="map" 
           style="height: 600px; border-radius: 8px;" 
           role="application" 
           aria-label="Mapa interactivo de puntos de control"></div>
    </section>

    <!-- ============================================
         PESTA√ëA 7: ADMINISTRACI√ìN DE PUNTOS
         ============================================ -->
    <section id="puntos-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-puntos">
      <h2>Administrar Puntos de Control</h2>
      
      <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;" role="toolbar" aria-label="Acciones de puntos">
        <button type="button" 
                class="btn-success" 
                data-action="nuevo-punto"
                aria-label="Agregar nuevo punto de control">
          + Agregar Nuevo Punto
        </button>
        <button type="button" 
                class="btn-primary" 
                data-action="importar-coordenadas"
                aria-label="Importar coordenadas desde CSV">
          üì• Importar Coordenadas CSV
        </button>
        <button type="button" 
                class="btn-secondary" 
                data-action="descargar-plantilla-csv"
                aria-label="Descargar plantilla CSV">
          üìÑ Plantilla CSV
        </button>
      </div>

      <div class="table-container" role="region" aria-label="Tabla de puntos de control">
        <table id="tablaPuntos" role="table">
          <thead>
            <tr role="row">
              <th role="columnheader">Punto</th>
              <th role="columnheader">Regi√≥n</th>
              <th role="columnheader">Comuna</th>
              <th role="columnheader">Tipo</th>
              <th role="columnheader">Ruta/Km</th>
              <th role="columnheader" style="text-align:center;">GPS</th>
              <th role="columnheader">Coordenadas</th>
              <th role="columnheader">Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaPuntosCuerpo" role="rowgroup"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- ============================================
       MODAL: NUEVO/EDITAR PUNTO
       ============================================ -->
  <div id="modalNuevoPunto" class="modal" role="dialog" aria-hidden="true" aria-labelledby="modalTitulo" aria-modal="true">
    <div class="modal-content">
      <button class="close" data-action="cerrar-modal-punto" aria-label="Cerrar modal">&times;</button>
      <h2 id="modalTitulo">Agregar Punto de Control</h2>
      
      <form id="formNuevoPunto" novalidate>
        <input type="hidden" id="editandoPuntoNombre"/>

        <h3 style="margin-top:0;border-bottom:2px solid var(--primary-color);padding-bottom:10px;">
          üìç Informaci√≥n B√°sica
        </h3>
        
        <div class="form-grid">
          <div class="form-group">
            <label for="nuevoPuntoNombre">Nombre del Punto <span class="required">*</span></label>
            <input type="text" 
                   id="nuevoPuntoNombre" 
                   name="nombrePunto" 
                   required 
                   aria-required="true"
                   maxlength="100"/>
          </div>

          <div class="form-group">
            <label for="nuevoPuntoRegion">Regi√≥n <span class="required">*</span></label>
            <input type="text" 
                   id="nuevoPuntoRegion" 
                   name="regionPunto" 
                   required 
                   aria-required="true"
                   maxlength="100"/>
          </div>

          <div class="form-group">
            <label for="nuevoPuntoComuna">Comuna <span class="required">*</span></label>
            <input type="text" 
                   id="nuevoPuntoComuna" 
                   name="comunaPunto" 
                   required 
                   aria-required="true"
                   maxlength="100"/>
          </div>

          <div class="form-group">
            <label for="nuevoPuntoProvincia">Provincia <span class="required">*</span></label>
            <input type="text" 
                   id="nuevoPuntoProvincia" 
                   name="provinciaPunto" 
                   required 
                   aria-required="true"
                   maxlength="100"/>
          </div>

          <div class="form-group">
            <label for="nuevoPuntoTipo">Tipo de Control <span class="required">*</span></label>
            <select id="nuevoPuntoTipo" name="tipoPunto" required aria-required="true">
              <option value="Pista de Pesaje">Pista de Pesaje</option>
              <option value="Calzada">Calzada</option>
            </select>
          </div>

          <div class="form-group">
            <label for="nuevoPuntoFoso">Foso <span class="required">*</span></label>
            <select id="nuevoPuntoFoso" name="fosoPunto" required aria-required="true">
              <option value="Si">S√≠</option>
              <option value="No">No</option>
            </select>
          </div>

          <div class="form-group">
            <label for="nuevoPuntoRuta">Ruta <span class="required">*</span></label>
            <input type="text" 
                   id="nuevoPuntoRuta" 
                   name="rutaPunto" 
                   required 
                   aria-required="true"
                   maxlength="50"/>
          </div>

          <div class="form-group">
            <label for="nuevoPuntoKm">Kil√≥metro <span class="required">*</span></label>
            <input type="text" 
                   id="nuevoPuntoKm" 
                   name="kmPunto" 
                   required 
                   aria-required="true"
                   maxlength="20"/>
          </div>

          <div class="form-group">
            <label for="nuevoPuntoSentido">Sentido de Control <span class="required">*</span></label>
            <input type="text" 
                   id="nuevoPuntoSentido" 
                   name="sentidoPunto" 
                   required 
                   aria-required="true"
                   maxlength="100"/>
          </div>
        </div>

        <h3 style="margin-top:30px;border-bottom:2px solid var(--success-color);padding-bottom:10px;">
          üåç Coordenadas GPS
        </h3>
        
        <div class="form-grid">
          <div class="form-group">
            <label for="nuevoPuntoLat">
              Latitud 
              <small style="color:var(--text-secondary);">(Ej: -18.537829)</small>
            </label>
            <input type="number" 
                   id="nuevoPuntoLat" 
                   name="latPunto" 
                   step="0.000001" 
                   min="-90" 
                   max="90" 
                   placeholder="-33.4489"
                   data-action="validar-coordenada"
                   aria-describedby="latError"/>
            <small id="latError" class="error-message hidden" role="alert">‚ö†Ô∏è Latitud inv√°lida (-90 a 90)</small>
          </div>

          <div class="form-group">
            <label for="nuevoPuntoLng">
              Longitud 
              <small style="color:var(--text-secondary);">(Ej: -70.771886)</small>
            </label>
            <input type="number" 
                   id="nuevoPuntoLng" 
                   name="lngPunto" 
                   step="0.000001" 
                   min="-180" 
                   max="180" 
                   placeholder="-70.6693"
                   data-action="validar-coordenada"
                   aria-describedby="lngError"/>
            <small id="lngError" class="error-message hidden" role="alert">‚ö†Ô∏è Longitud inv√°lida (-180 a 180)</small>
          </div>
        </div>

        <!-- Ayuda para GPS -->
        <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid var(--info-color);">
          <h4 style="margin:0 0 10px 0; font-size:14px;">üí° ¬øC√≥mo obtener coordenadas?</h4>
          <ol style="margin:0; padding-left:20px; font-size:13px;">
            <li>Abre <a href="https://www.google.com/maps" target="_blank" rel="noopener noreferrer" style="color: var(--primary-color);">Google Maps</a></li>
            <li>Busca el punto de control</li>
            <li>Click derecho ‚Üí "¬øQu√© hay aqu√≠?"</li>
            <li>Copia las coordenadas (aparecen abajo)</li>
          </ol>
          <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;">
            <button type="button" 
                    class="btn-secondary" 
                    style="font-size:12px;padding:6px 12px;" 
                    data-action="usar-ubicacion"
                    aria-label="Usar mi ubicaci√≥n actual">
              üìç Usar Mi Ubicaci√≥n
            </button>
            <button type="button" 
                    class="btn-secondary" 
                    style="font-size:12px;padding:6px 12px;" 
                    data-action="abrir-maps"
                    aria-label="Abrir Google Maps">
              üó∫Ô∏è Abrir Google Maps
            </button>
          </div>
        </div>

        <!-- Previsualizaci√≥n del Mapa -->
        <div id="previewMap" 
             style="height: 200px; border-radius: 8px; margin: 15px 0; border: 2px solid var(--border-color); display: none;"
             role="application"
             aria-label="Previsualizaci√≥n del mapa"></div>
        
        <button type="button" 
                class="btn-secondary" 
                data-action="previsualizar-mapa" 
                style="width: 100%; margin-bottom: 15px;">
          üëÅÔ∏è Previsualizar en Mapa
        </button>

        <!-- Acciones del Modal -->
        <div class="form-actions" style="justify-content:flex-end;">
          <button type="button" 
                  class="btn-secondary" 
                  data-action="cerrar-modal-punto">
            Cancelar
          </button>
          <button type="submit" 
                  class="btn-primary" 
                  id="btnGuardarPunto"
                  data-loading="false">
            <span class="btn-text">üíæ Guardar Punto</span>
            <span class="btn-spinner hidden">‚è≥ Guardando...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ============================================
       MODAL: LOGIN
       ============================================ -->
  <div id="modalLogin" class="modal" role="dialog" aria-hidden="true" aria-labelledby="modalLoginTitle" aria-modal="true">
    <div class="modal-content modal-small">
      <button class="close" data-action="cerrar-modal-login" aria-label="Cerrar modal">&times;</button>
      <h2 id="modalLoginTitle">Iniciar Sesi√≥n</h2>
      
      <form id="loginForm" novalidate>
        <div class="form-group">
          <label for="username">Usuario</label>
          <input type="text" 
                 id="username" 
                 name="username" 
                 required 
                 aria-required="true"
                 autocomplete="username"
                 maxlength="50"/>
        </div>
        
        <div class="form-group">
          <label for="password">Contrase√±a</label>
          <input type="password" 
                 id="password" 
                 name="password" 
                 required 
                 aria-required="true"
                 autocomplete="current-password"
                 maxlength="100"/>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn-primary" data-loading="false">
            <span class="btn-text">Entrar</span>
            <span class="btn-spinner hidden">‚è≥</span>
          </button>
        </div>
      </form>
      
      <div style="background: var(--bg-secondary); padding: 10px; border-radius: 4px; margin-top: 15px; border-left: 3px solid var(--warning-color);">
        <p style="text-align: center; margin: 0; font-size: 12px; color: var(--text-secondary);">
          <strong>‚ö†Ô∏è DEMO:</strong> admin/admin | editor/editor | viewer/viewer
        </p>
        <p style="text-align: center; margin: 5px 0 0 0; font-size: 11px; color: var(--text-muted);">
          Sistema solo para demostraci√≥n - No usar en producci√≥n
        </p>
      </div>
    </div>
  </div>

  <!-- ============================================
       TOAST DE NOTIFICACIONES
       ============================================ -->
  <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true"></div>

  <!-- ============================================
       SCRIPTS
       ============================================ -->
  <!-- Script principal -->
  <script src="script.js" defer></script>
  
  <!-- M√≥dulos -->
  <script src="Modules/horas-control.js" defer></script>
  <script src="Modules/coordenadas-helper.js" defer></script>
  <script src="Modules/filters.js" defer></script>
  <script src="Modules/charts.js" defer></script>
  <script src="Modules/pdf-export.js" defer></script>
  <script src="Modules/backup.js" defer></script>
  <script src="Modules/calendar.js" defer></script>
  <script src="Modules/notifications.js" defer></script>
  <script src="Modules/maps.js" defer></script>
  <script src="Modules/users.js" defer></script>
  <script src="Modules/analytics.js" defer></script>

  <!-- Event Delegation Manager (NUEVO) -->
  <script defer>
    /* ==========================================
       EVENT DELEGATION MANAGER
       Maneja todos los eventos sin onclick inline
       ========================================== */
    document.addEventListener('DOMContentLoaded', () => {
      // Delegaci√≥n global de clicks
      document.addEventListener('click', (e) => {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;
        
        // Acciones de la barra superior
        if (action === 'show-login') Users?.showLoginModal();
        if (action === 'toggle-notifications') Notifications?.togglePanel();
        if (action === 'toggle-theme') App?.toggleDarkMode();
        if (action === 'clear-notifications') Notifications?.clearAll();

        // Navegaci√≥n de tabs
        if (action === 'show-tab') {
          const tabId = target.dataset.tab;
          if (tabId && App?.ui) App.ui.showTab(tabId, e);
        }

        // Formulario principal
        if (action === 'filter-region') App?.ui?.actualizarSelectPuntos?.(e.target.value);
        if (action === 'nuevo-punto') App?.ui?.abrirModalNuevoPunto();
        if (action === 'limpiar-form') App?.form?.limpiar();

        // Horas y observaciones
        if (action === 'ajustar-horas-manual') HorasControl?.ajustarManual();
        if (action === 'aplicar-horas-manual') HorasControl?.aplicarManual();
        if (action === 'plantilla-obs') {
          const texto = target.dataset.texto;
          if (texto) HorasControl?.agregarPlantilla(texto);
        }
        if (action === 'limpiar-obs') HorasControl?.limpiarObservaciones();

        // Filtros
        if (action === 'toggle-filters') Filters?.togglePanel();
        if (action === 'aplicar-filtros') Filters?.apply();
        if (action === 'limpiar-filtros') Filters?.clear();

        // Exportaci√≥n
        if (action === 'exportar-csv') App?.exportar?.csv();
        if (action === 'exportar-pdf') PDFExport?.generate();
        if (action === 'backup-exportar') Backup?.export();
        if (action === 'backup-importar') Backup?.import();

        // Ordenamiento de tabla
        if (action === 'sort') {
          const column = target.dataset.column;
          if (column) Filters?.sortBy(column);
        }

        // Puntos de control
        if (action === 'importar-coordenadas') CoordenadasHelper?.importarCSV();
        if (action === 'descargar-plantilla-csv') CoordenadasHelper?.descargarPlantillaCSV();

        // Modal de punto
        if (action === 'cerrar-modal-punto') App?.ui?.cerrarModalNuevoPunto();
        if (action === 'validar-coordenada') CoordenadasHelper?.validar(target.id);
        if (action === 'usar-ubicacion') CoordenadasHelper?.obtenerUbicacion();
        if (action === 'abrir-maps') CoordenadasHelper?.abrirMaps();
        if (action === 'previsualizar-mapa') CoordenadasHelper?.previsualizarMapa();

        // Modal de login
        if (action === 'cerrar-modal-login') Users?.closeLoginModal();

        // Mapa
        if (action === 'mapa-mostrar-todos') MapModule?.showAll();
        if (action === 'mapa-filtrar-infracciones') MapModule?.filterByInfractions();
      });

      // Delegaci√≥n de cambios (change events)
      document.addEventListener('change', (e) => {
        const target = e.target;
        const action = target.dataset.action;

        if (action === 'calcular-horas') HorasControl?.calcularTotal();
        if (action === 'calcular-promedios') HorasControl?.calcularPromedios();
        if (action === 'select-punto') {
          const datos = App?.data?.puntos?.[target.value];
          if (datos) {
            document.getElementById('region').value = datos.region || '';
            document.getElementById('comuna').value = datos.comuna || '';
            document.getElementById('provincia').value = datos.provincia || '';
            document.getElementById('foso').value = datos.foso || '';
            document.getElementById('ruta').value = datos.ruta || '';
            document.getElementById('kilometro').value = datos.kilometro || '';
            document.getElementById('sentido').value = datos.sentido || '';
          }
        }
      });

      // Delegaci√≥n de input (keyup, input)
      document.addEventListener('input', (e) => {
        const target = e.target;
        const action = target.dataset.action;

        if (action === 'actualizar-contador') HorasControl?.actualizarContador(target);
        if (action === 'buscar-registros') Filters?.search(target.value);
      });

      // Cerrar modales al hacer click fuera
      window.addEventListener('click', (e) => {
        if (e.target.id === 'modalNuevoPunto') App?.ui?.cerrarModalNuevoPunto();
        if (e.target.id === 'modalLogin') Users?.closeLoginModal();
      });

      console.log('‚úÖ Event Delegation inicializado');
    });
  </script>

  <!-- PWA Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(registration => {
            console.log('‚úÖ Service Worker registrado:', registration.scope);
          })
          .catch(error => {
            console.log('‚ùå Error al registrar Service Worker:', error);
          });
      });
    }

    // PWA Install Prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Notificar al usuario que puede instalar
      if (typeof Notifications !== 'undefined') {
        Notifications.add('üì± ¬°Puedes instalar esta app en tu dispositivo!', 'info');
      }
    });

    // Detectar instalaci√≥n exitosa
    window.addEventListener('appinstalled', () => {
      console.log('‚úÖ PWA instalada exitosamente');
      deferredPrompt = null;
      
      if (typeof App !== 'undefined' && App.toast) {
        App.toast('‚úÖ App instalada correctamente', 'success');
      }
    });
  </script>
</body>
</html>
